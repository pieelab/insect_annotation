# A shiny tool to manually label tiled tuboids.

Typically, tuboids are generated by the sticky pi siamese-insect-matcher in a directory structure:
```
<sticky_pi_client_root_dir>/tiled_tuboids/<series_id>/<tuboid_id>/
```

## On your machine/workstation, manually copy/upload all tuboids to a dedicated s3 bucket

1. Set up an s3bucket
```
BUCKET_NAME=tuboid-annotation-data
TUBOID_DATA_DIR=<sticky_pi_client_root_dir>/tiled_tuboids
s3cmd mb s3://${BUCKET_NAME}
```

1. Make index file, and upload it:
```sh
Rscript make_s3_bucket_index.R ${TUBOID_DATA_DIR} /tmp/index.csv
s3cmd put /tmp/index.csv s3://${BUCKET_NAME} && rm /tmp/index.csv
``` 

1. Generate taxonomy file, and upload it:
```sh
python pull_taxonomy.py /tmp/taxonomy.json
s3cmd put /tmp/taxonomy.json s3://${BUCKET_NAME} && rm /tmp/taxonomy.json 
```

1. Put all the files, recusively
```
s3cmd sync ${TUBOID_DATA_DIR}/ s3://${BUCKET_NAME}
```

1. Make candidate labels
```
python make_candidates.py /tmp/candidate_labels.csv
s3cmd put /tmp/candidate_labels.csv s3://${BUCKET_NAME} && rm /tmp/candidate_labels.csv 
```

## Deployment

1. copy/make a s3cmd config file and name it `.secret_s3cmd_conf`  (in this directory). this can be a read-only key


```sh
BUCKET_NAME=<my_annotation_bucket>
VERSION=3.0
LOCAL_VOLUME=/opt/tuboid_annotation_volume
# should be open to the world (e.g via nginx)
PORT=8099
SHINY_UID=9991
mkdir -p ${LOCAL_VOLUME}

# make credential file
echo  {'"user1"':'"password1"'} > ${LOCAL_VOLUME}/credentials.json
chmod 460 ${LOCAL_VOLUME}/credentials.json
chown ${SHINY_UID}:root -R ${LOCAL_VOLUME}
```

```
docker build --build-arg SHINY_UID=${SHINY_UID} .  --tag insect_annotation:$VERSION
docker run --rm  --publish $PORT:80 --name insect_annotation --env DATA_ROOT_DIR=/opt/data_root_dir  --env S3_BUCKET=${BUCKET_NAME} --volume ${LOCAL_VOLUME}:/opt/data_root_dir -d  insect_annotation:$VERSION
```

